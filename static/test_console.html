<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Prolog console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
   
    <script type="text/javascript">
    var ws = new Object;
    var ws_trace = new Object;
    var history = new Array();
    var index = 0;
    HOST = "codeide.com/";
    var wait_answer = 0 ;
    var editor;
    var LOADED = 0;
    WHOST = "ws://" + HOST; //"ws://hd-test-2.ceb.loc:10100";
    
    function listen(obj, E){
	  if(E.keyCode == 13 ){
		Code = $.trim(obj.value);
		if(wait_answer){
			if(Code != "yes." && Code != "no."){
				$("<p>| -? Enter yes. or no. </p>").insertBefore("#sse");
				scroll_console();
				return;			
			}
		}
		
		if( Code.charAt(Code.length - 1) == "." ){
		
			  var Var  = "<p>| -? " + obj.value+"</p>";
			  
			  var Var1 = obj.value;
			  Var1 = Var1.replace("\n","");
			  Var1 = Var1 + " ";
			  obj.value ="";
			  $("<p>| -? " + Var +"</p>").insertBefore("#sse");
			  scroll_console();
			  wait_answer = 0;
			  history[$.trim(Var1)] = 1 ;
			  index = 0;
			  send(Var1);
			  
     	  	          $("#code").prop("disabled", true);     

		}
	  
	  }
	   if(E.keyCode == 38 ){//up
		  if(index == 0)
			return ;
		
		  if(index == 1){
		  
			document.getElementById("code").value = "";
			index = 0;
			return ;
		  }
		  
		  var i = 0;
		  for(key in history){
			  if(i+1 == index){
			   
			  	document.getElementById("code").value = key;

// 				$("#code").attr( { "value": key } );
				index = i;
				return ;

			  }
			  i++;
		  }
		  
	
	  }
	  if(E.keyCode == 40 ){//down
	  
		 var i = 1;
		 
		 for(key in history){
			  if(i-1 ==  index){
			  	document.getElementById("code").value = key;
// 				$("#code").attr(  "value", key  );
				index = i;
				return ;
			  }
			  i++;
			  
		  }
	  
	  
	  
	  }
	  
	  
    }
     function scroll_console(){
	 $("#msgs").animate({
			      scrollTop: $("#msgs").get(0).scrollHeight
			    }, 1500);
	  
    
    }
    function scroll_trace(){
	 $("#trace_msg").animate({
			      scrollTop: $("#trace_msg").get(0).scrollHeight
			    }, 1500);
	  
    
    }
    
    function listen_trace(obj, E){
	  if(E.keyCode == 13 ){
		    Code = $.trim(obj.value);
		    if( Code == "yes." ){
			      var Var  = "<p>| -? " + obj.value+"</p>";
			      
			      var Var1 = obj.value;
			      Var1 = Var1.replace("\n","");
			      Var1 = Var1 + " ";
			      obj.value ="";
   		      	       $("<p>| -? " + Var1 +"</p>").insertBefore("#trace_sse");	    
			      scroll_trace();
			      send_trace(Var1);
       	  	              $("#trace_input").prop("disabled", true);
			      return  ;
		    }
		    if( Code == "no." ){
		          var Var  = "<p>| -? " + obj.value+"</p>";
			  var Var1 = obj.value;
			  Var1 = Var1.replace("\n","");
			  Var1 = Var1 + " ";
			  obj.value ="";
			  
			  $("<p>| -? " + Var1 +"</p>").insertBefore("#trace_sse");
			   send_trace(Var1);
			   scroll_trace();
   	  	          $("#trace_input").prop("disabled", true);

			  return  ; 
		    }
		
		    alert("Enter yes or no please");
			
			  
		}
	  
	  
    }
   
    function  reloadall_code(){
		    var new_function = function(Data){
			  $("<p>| -? " + Data +"</p>").insertBefore("#sse");
			  scroll_console();
			  
		    }
		    var  params = { code: editor.getValue()  };
	            $.ajax({
                        type: "POST",
                        url: "http://" + HOST +"reload" ,
                        data: params,
                        success: new_function
                        
                        }
                      );
    
    
    }
    function show_trace(){
	  $("#trace").slideDown("slow");
    
    
    }
    function close_editor(){
    
	  
    
	 $("#container_editor").hide("fast");
    
    }
    function clear_console(){
	$("#msgs").html("");
	clear_trace();
	
    
    }
      function close_console1(){
      
	$("#console").hide("fast");
	close_trace();
    
    }
    function close_trace(){
	    
	      
	  $("#trace").hide("fast");
    }
    function clear_trace(){

	  $("#trace_msg").html("");
    }
    function show_online(){
    
	    close_console1();
	    if(LOADED==0){
		var new_function=function(Data){
		      editor.setValue(Data);
		      LOADED=1;
		};
	      
		$.ajax({
			    type: "GET",
			    contentType: 'text/plain',
			    url: "http://" + HOST +"plain_code" ,
			    success: new_function,
			    }
		);
	    }
	    $("#container_editor").slideDown("slow");
    
    
    }
    function export_code(){
		alert("not implemented");
    
    }
    
    function load_code(){
		    var new_function = function(Data){
// 			  $("<p>| -? " + Data +"</p>").appendTo("#msgs");
			  alert("Code loaded");
			  
		    }
		    Code = editor.getValue(),
		    //hack for numbers
		    Code = Code.replace(/(\d+)\.(\d+)/mg,"$1#%#$2");
   		    Code = $.trim(Code);

		    var  params = { code: Code   };
	            $.ajax({
                        type: "POST",
                        url: "http://" + HOST +"upload_code" ,
                        data: params,
                        success: new_function
                        
                        }
                      );
    
    }
    function send_trace(Code){
	ws_trace.send(Code);
	console.log('Message sent to trace');
    }
    function send(Code)
    {
    
	send_trace("next");/* at first time*/
	ws.send(Code);
	console.log('Message sent');
    }
    
    function close_console(){
	 	  document.getElementById("container").innerHTML="Good bye";
		  ws.close();
    
    }

    function open_console()
    {
	if (!("WebSocket" in window)) {
	    alert("This browser does not support WebSockets");
	    return;
	}
	close_editor();
	$("#console").slideDown("slow");
	$("#code").prop("disabled", false);
	$("#code").focus();
	show_trace();
// // 	document.getElementById("code").value='';
// 	$("#code").focus();
	

	/* @todo: Change to your own server IP address */
	
    }

    </script>
    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      #editor { 
		height: 800px;
/*		left: 600px;*/
		position: relative;
/*		right: 0;*/
/*		top: 100px;*/
		width: 800px;
      }
      #container_editor{
/*	  float: right;*/
	    display: none;
	    margin-left: 7em;
/*     margin-top: 100px; */
	    width: 800px;
      
      }
      #right_part{
	/*  float: left;
	  width: 600px;
	  margin-left:1em;*/
	  margin-top:2em;
	     margin-left: 7em;
	    width: 800px;
      
      }
      div.right{
	float:right
      }
      div.left{
	float:left
      }
      #trace{
	    width:800px;
	    display:none;
	    
/*	    float:right*/
      }
    </style>
    <link href="css/bootstrap-responsive.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->


  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container"  >
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
<!--             <span class="icon-bar"></span> -->
<!--             <span class="icon-bar"></span> -->
<!--             <span class="icon-bar"></span> -->
          </button>
          <a class="brand" href="#">Prolog console</a>
          
          <div class="nav-collapse collapse">
            <ul class="nav">
<!--               <li class="active"><a href="#">Home</a></li> -->
<!--               <li><a href="#about">About</a></li> -->
<!--               <li><a href="#contact">Contact</a></li> -->
            </ul>\
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container" id="container" style='border-bottom: 1px solid gray' >
	  <div  id='tabs' >
	        <a style='padding-left: 1em;' href="javascript:open_console()">Console</a>
		<a style='padding-left: 1em;' href="javascript:show_online()">Online IDE</a>
<!--	        <a style='padding-left: 1em;' href="javascript:show_trace()">Show trace</a>-->
	        
<!--	        <a href="javascript:show_all_code()">Show code</a>-->


<!--	        <a style='padding-left: 1em;' href="javascript:reloadall_code()">Load hbase</a>-->


          </div>
     </div>    
      <div id='console' style='margin-left: 7em;  width:800px; display:none; margin-top: 2em; float:left'  >
		<div class="right"><!--<a  style='padding-left: 1em;' href="javascript:clear_console()">Clear</a>-->
				    <a  style='padding-left: 1em;' href="javascript:close_console1()">Close console</a></div>  
		<p>*Type 'help' for listing inner commands </p>
		
		<div id="msgs" style="font-size: 12px;height:300px;
				      width: 800px;border:1px solid black;
				       overflow: auto;
				      ">
		<p class='console_p'> Prolog 0.5 </p>
		
		
	      
			<div id="sse" >
			  <div style="float:left;font-size: 12px;">| - ?&nbsp;</div>
			    <div style="float:left">
			    <input id="code"  style="border:1px solid #0088CC ; width:775px; height:20px;font-size:12px" 
				      onkeyup="listen(this,event)" />
			  </div> 
			  
			  
			</div>
			
		</div>
      </div>
      <div id='right_part' >
      <div id='trace'  >
      <h4>Trace :  </h4>
		<div id="trace_msg" style=" overflow: auto;font-size: 12px;height:200px; width: 800px;border:1px solid black;">
		
		
		
		    		<div id="trace_sse" >
				  <div style="float:left;font-size: 12px;">| - ?&nbsp;</div>
				  <div style="float:left">
				      <input id="trace_input" rows='3' style="border:1px solid #0088CC;
						      width:775px; height:20px; 
						      font-size:12px" 
						      onkeyup="listen_trace(this,event)" />
				  </div> 
			      </div>
		    
		    
		    
		    
		    
		</div>
      </div>

   
    </div> <!--right part-->
   
   
      <div id='container_editor' > 
      <h4> Editor  </h4><div class="right">
			<a  style='padding-left: 1em;' href="javascript:load_code()">Load Code</a>
			<a  style='padding-left: 1em;' href="javascript:close_editor()">Close editor</a></div> 
      
       <div id='editor'></div>
      
      
      </div>
      
   
   
    </div>

    <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery1.9.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

<script src="js/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    $(document).ready(function() {
    
	
	Key = Math.random();
	// Handler for .ready() called.
	
	ws = new WebSocket(WHOST+Key);
	ws.onopen = function() {
	    console.log('Connected');
	};
	ws.onmessage = function (evt)
	{
	    var received_msg = evt.data;
	    console.log("Received: " + received_msg);
	    var obj =  document.getElementById('msgs');
	    
// 	    $("<p>| -? " + received_msg +"</p>").appendTo("#msgs");
	    var patt=/looking next \?/;
	    var result=patt.test(received_msg);
	    if(result){
		wait_answer = 1;
	    }

	    $("<p>| -? " + received_msg +"</p>").insertBefore("#sse");	    

	    $("#trace_input").prop("disabled", true);
    	    $("#code").prop("disabled", false);
	    $("#code").focus();
// 	    $("#sse").animate({ scrollTop: $("#sse").height() }, "slow");
	    scroll_console();
	    
	    // 	    obj.scrollTo(0, obj.scrollHeight);
	    
	};
	ws.onclose = function()
	{
	    console.log('Connection closed');
	};

	
	ws_trace = new WebSocket(WHOST+"trace/" + Key);
	ws_trace.onopen = function() {
	    console.log('Connected');
	};
	ws_trace.onmessage = function (evt)
	{
	    var received_msg = evt.data;
	    console.log("Received: " + received_msg);
	    if(received_msg !="finish"){
	    
		$("#trace_input").prop("disabled", false);
		$("#trace_input").focus();    
	        $("<p>| -? " + received_msg +"</p>").insertBefore("#trace_sse");	    
	        scroll_trace();

	    }
	    

	};
	ws_trace.onclose = function()
	{
	    console.log('Connection closed');
	};
	
	editor = ace.edit("editor");

    });
    
</script>


</body>
</html>
